// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserPlan {
  FREE
  PREMIUM
}

enum EventStatus {
  PLANNED
  COMPLETED
  CANCELLED
}

enum RoleInEvent {
  ORGANISER
  ENCADRANT
  PARTICIPANT
}

enum EventParticipantStatus {
  INVITED
  GOING
  MAYBE
  DECLINED
}

enum RouteType {
  ROUTE
  TRAIL
  MIXED
}

enum NotificationType {
  EVENT_REMINDER_PARTICIPANT
  EVENT_REMINDER_ORGANISER
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email     String? @unique
  // Pour les Guests sans email on laissera null, ou on forcera plus tard.
  firstName String
  lastName  String?
  isGuest   Boolean @default(false)

  // Free / Premium
  plan      UserPlan  @default(FREE)
  planSince DateTime?
  planUntil DateTime?

  acceptedTermsAt DateTime?

  // Relations
  organisedEvents Event[]            @relation("OrganiserEvents")
  participations  EventParticipant[]
  routes          Route[]

  @@index([plan])
}

// Événement global : "Run du jeudi soir – Run & Drink"
model Event {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title         String
  description   String?
  startDateTime DateTime
  status        EventStatus @default(PLANNED)

  // Organisateur principal
  organiserId String
  organiser   User   @relation("OrganiserEvents", fields: [organiserId], references: [id])

  // Lieu (MVP : simple, pourra évoluer plus tard)
  locationName    String?
  locationAddress String?
  locationLat     Float?
  locationLng     Float?

  // Accès event (QR/code)
  eventCode String @unique

  // Relations
  routes       EventRoute[]
  participants EventParticipant[]

  @@index([organiserId, startDateTime])
  @@index([status, startDateTime])
}

model Route {
  id              String     @id @default(cuid())
  ownerId         String
  owner           User       @relation(fields: [ownerId], references: [id])
  name            String
  encodedPolyline String
  distanceMeters  Int
  centerLat       Float
  centerLng       Float
  radiusMeters    Float
  type            RouteType?

  eventRoutes EventRoute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventRoute {
  id              String     @id @default(cuid())
  eventId         String
  event           Event      @relation(fields: [eventId], references: [id])
  routeId         String?
  route           Route?     @relation(fields: [routeId], references: [id])
  name            String
  distanceMeters  Int
  type            RouteType?
  encodedPolyline String

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  eventGroups       EventGroup[]
  eventParticipants EventParticipant[]
}

// Groupe d'allure sur un EventRoute (10–11 km/h, 12+ km/h…)
model EventGroup {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  eventRouteId String
  eventRoute   EventRoute @relation(fields: [eventRouteId], references: [id])

  label      String
  paceMinKmh Float?
  paceMaxKmh Float?

  // Participants rattachés à ce groupe
  participants EventParticipant[] @relation("GroupParticipants")
}

// Participation / rôle d'un user sur un event
model EventParticipant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  role   RoleInEvent            @default(PARTICIPANT)
  status EventParticipantStatus @default(GOING)

  // Choix du parcours
  eventRouteId String?

  // Choix du groupe d'allure
  eventGroupId String?
  eventGroup   EventGroup? @relation("GroupParticipants", fields: [eventGroupId], references: [id])
  eventRoute   EventRoute? @relation(fields: [eventRouteId], references: [id])

  @@index([eventId, userId], name: "idx_event_user")
  @@index([eventId, status])
}

model Notification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId  String
  eventId String?

  type  NotificationType
  title String
  body  String
  data  Json?

  @@unique([userId, eventId, type])
  @@index([userId, createdAt])
}
